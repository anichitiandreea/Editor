<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="../build/css/styles.css">
    <link 
        rel="stylesheet" 
        href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" 
        integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" 
        crossorigin="anonymous">
</head>
<body>
    <div style="display: flex;flex-direction: column;justify-content: center;align-items: center;height: 100%;">
    <div class="textarea-content">
        <div class="textarea-menu" id="editor-menu">
            <ul class="textarea-ul">
                <li><button onclick="editorModule.enableBold();" class="disabledButton" type="button" id="bold" title="Bold"><i class="fas fa-bold"></i></button></li>
                <li><button onclick="editorModule.enableItalic();" class="disabledButton" type="button" id="italic" title="Italic"><i class="fas fa-italic"></i></button></li>
                <li><button onclick="editorModule.enableUnderline();" class="disabledButton" id="underline" type="button" title="Underline"><i class="fas fa-underline"></i></button></li>
                <li><button onclick="editorModule.enableBulleted();" class="disabledButton" id="bullet" type="button" title="Bulleted list"><i class="fas fa-list"></i></button></li>
                <li><button onclick="editorModule.enableNumbered();" class="disabledButton" id="numbered" type="button" title="Numbered list"><i class="fas fa-list-ol"></i></button></li>
                <li>
                    <button type="button" class="hyperlink disabledButton" title="Hyperlink" id="link"><i class="fas fa-link"></i></button>
                    <div id="insert-link">
                        <input type="text" placeholder="URL" id="url" autocomplete="off" class="link-input">
                        <input type="text" placeholder="Text" id="text" autocomplete="off" class="link-input" style="margin-bottom: 0;">
                        <div class="submit" style="width: 100%;">
                            <input type="button" value="Insert" id="insert">
                        </div>
                    </div>
                </li>
            </ul>
        </div>
        <div id="textarea" spellcheck="false" contentEditable=true class="description" onkeyup="editorModule.completePreview();" data-text="Description" style="outline: none;">
        </div>
        <textarea id="textarea-real" name="details" style="display: none;"></textarea>
    </div>
    <div class="preview" id="preview"></div>
    </div>
    <button id="mybutton">append</button>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
 <script src="../src/functionality.js"></script> 
 <script>
    editorModule.preventDefaultClick();  
    editorModule.addLink();  
    editorModule.disableTextareaButtons();

    /*jQuery('#textarea').click(function(e)  {
    	e = e || window.event;
    	var target = e.target || e.srcElement,
        	text = target.textContent || target.innerText; 

        editorModule.checkButtonsActive(target);
        console.log(target);



        /* s = window.getSelection();
         var range = s.getRangeAt(0);
         var node = s.anchorNode;
         while(range.toString().indexOf(' ') != 0) {                 
            range.setStart(node,(range.startOffset -1));
         }

         range.setStart(node, range.startOffset +1);
         do{
           range.setEnd(node,range.endOffset + 1);

        }while(range.toString().indexOf(' ') == -1 && range.toString().trim() != '');
        var str = range.toString().trim();
        alert(str);*/

        ////////

        /*var htmlText = $('#textarea').text(); //the big divs text
        
        
        var children = $('#textarea').children(); //get dom elements so they can be ignored later
        
        $.each(children, function (index, child) {
            var txt = $(child).text().trim(); 
            if (txt != '') { //if a child has text in him
                htmlText = htmlText.replace(txt, 'xxx'); //replace it in the big text with xxx
            }
        });

        
        console.log(htmlText);
        htmlText = htmlText.split("xxx"); //split for xxx make it arrat
        
        var counter = 0; //the part when the text is added
        $.each(htmlText, function (i, el) {
            htmlText[i] = el.trim();
        
            if (htmlText[i] != "") { //if there is something here than it's my text
                htmlText[i] = '<span class="text">' + htmlText[i] + '</span>'; //replace it with a HTML element personalized
                counter++; //mark that you have replaced the text
            } else { // if there is nothing at this point it means that I have a DOM element here
                htmlText[i] = $(children[i - counter])[0].outerHTML; //add the DOM element
            }
        });
        
        if (children.length >= htmlText.length) { //you might have the case when not all the HTML children were added back 
            for (var i = htmlText.length - 1; i < children.length; i++) {
                htmlText[i + 1] = $(children[i])[0].outerHTML; //add them
            }
        }
        
        htmlText = htmlText.join(""); //form a HTML markup from the altered stuff
        
        $('.foo').html(htmlText); // replace the content of the big div
        
        $('.text').on('click', function (data) { //add click support
            alert('ok');
        });*/

     

   // });

    var foo = document.querySelector( "#textarea" );

foo.addEventListener( "click", function ( event ) {
		event = event || window.event;
    	var target = event.target || event.srcElement,
        	text = target.textContent || target.innerText; 

        //editorModule.checkButtonsActive(target);
        //console.log(target);

    //if ( event.srcElement === this ) {
    	//console.log(this);
    	//console.log(event)
        var clickedNode = textNodeFromPoint( this, event.clientX, event.clientY );
        var caretPosition = insertBreakAtPoint(event);
        console.log(caretPosition.tagName);
        if ( clickedNode ) {
            //alert( "You clicked: " + clickedNode.nodeValue );
            editorModule.checkButtonsActive(target);
        }

        if(caretPosition.tagName == "B") {
        	document.getElementById("bold").classList.add("item-active");
        }
        else {
        	document.getElementById("bold").classList.remove("item-active");
        }
   // } 
});

function textNodeFromPoint( element, x, y ) {
    var node, nodes = element.childNodes, range = document.createRange();
    for ( var i = 0; node = nodes[i], i < nodes.length; i++ ) {
    	//console.log(node)
        if ( node.nodeType !== 3 &&  node.nodeType !== 1 ) continue;
        range.selectNodeContents(node);
        if ( isInside( x, y, range.getBoundingClientRect() ) ) {
            return node;
        }
    }
    return false;
}

function insertBreakAtPoint(e) {
  var range;
  var textNode;
  var offset;

  if (document.caretPositionFromPoint) {
    range = document.caretPositionFromPoint(e.clientX, e.clientY);
    textNode = range.offsetNode;
    offset = range.offset;
  } else if (document.caretRangeFromPoint) {
    range = document.caretRangeFromPoint(e.clientX, e.clientY);
    textNode = range.startContainer;
    offset = range.startOffset;
  }

 return textNode.parentElement;
}

function isInside ( x, y, rect ) {
    return x >= rect.left  && y >= rect.top
    && x <= rect.right && y <= rect.bottom;
}



foo.addEventListener('keypress', logKey);

function logKey(e) {
	//console.log(e.target);
}

 </script>
</html>